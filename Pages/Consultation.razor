@page "/consultation"
@inject Services.JsonDataService Data
@inject Services.AccountingGenerator Generator
@inject Services.CSVBuilder CsvBuilder
@inject IJSRuntime JS

<h3>Consultation</h3>

@if (Loading)
{
    <p>Chargement...</p>
}
else
{
    <div class="card p-3 mb-3">
        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                <label>Référence facture</label>
                <input class="form-control" @bind="FilterRef" placeholder="Facture1" />
            </div>
            <div class="col-md-3">
                <label>Client</label>
                <input class="form-control" @bind="FilterClient" placeholder="Tintin" />
            </div>
            <div class="col-md-3">
                <label>Date du</label>
                <input type="date" class="form-control" @bind="DateFrom" />
            </div>
            <div class="col-md-3">
                <label>au</label>
                <input type="date" class="form-control" @bind="DateTo" />
            </div>

            <div class="col-12 mt-2">
                <button class="btn btn-secondary" @onclick="ApplyFilters">Filtrer</button>
                <button class="btn btn-outline-secondary ms-2" @onclick="ResetFilters">Reset</button>

                <button class="btn btn-outline-primary ms-2" @onclick="DownloadCsv">
                    Télécharger CSV
                </button>

            </div>
        </div>
    </div>

    <ul class="nav nav-tabs">
        <li class="nav-item">
            <button class="nav-link @(ActiveTab == "general" ? "active" : "")"
                    @onclick="SetTabGeneral">
                Écritures générales
            </button>
        </li>

        <li class="nav-item">
            <button class="nav-link @(ActiveTab == "aux" ? "active" : "")"
                    @onclick="SetTabAux">
                Écritures auxiliaires
            </button>
        </li>

        <li class="nav-item">
            <button class="nav-link @(ActiveTab == "bank" ? "active" : "")"
                    @onclick="SetTabBank">
                Relevé bancaire
            </button>
        </li>
    </ul>


    <div class="mt-3">
        @if (ActiveTab == "general")
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Compte</th>
                        <th>Description</th>
                        <th>Ref</th>
                        <th>Débit</th>
                        <th>Crédit</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in ViewGeneral)
                    {
                        <tr>
                            <td>@r.Date</td>
                            <td>@r.Compte</td>
                            <td>@r.Description</td>
                            <td>@r.Ref</td>
                            <td>@Fmt(r.Debit)</td>
                            <td>@Fmt(r.Credit)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else if (ActiveTab == "aux")
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Compte</th>
                        <th>Date</th>
                        <th>Nom</th>
                        <th>Ref</th>
                        <th>Débit</th>
                        <th>Crédit</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in ViewAux)
                    {
                        <tr>
                            <td>@r.Compte</td>
                            <td>@r.Date</td>
                            <td>@r.Nom</td>
                            <td>@r.Ref</td>
                            <td>@Fmt(r.Debit)</td>
                            <td>@Fmt(r.Credit)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Ref</th>
                        <th>Description</th>
                        <th>Nom</th>
                        <th>Montant</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in ViewBank)
                    {
                        <tr>
                            <td>@r.Date</td>
                            <td>@r.Ref</td>
                            <td>@r.Description</td>
                            <td>@r.Nom</td>
                            <td>@Fmt(r.Montant)</td>
                            <td>
                                <span class="badge @(r.Statut == "MATCHED" ? "bg-success" : "bg-warning text-dark")">
                                    @r.Statut
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
}

@code {
    private bool Loading = true;

    private List<Models.InvoiceDto> Invoices = new();
    private List<Models.PaymentDto> Payments = new();

    private List<Models.GeneralEntryRow> AllGeneral = new();
    private List<Models.AuxEntryRow> AllAux = new();
    private List<Models.BankStatementRow> AllBank = new();

    private List<Models.GeneralEntryRow> ViewGeneral = new();
    private List<Models.AuxEntryRow> ViewAux = new();
    private List<Models.BankStatementRow> ViewBank = new();

    private string ActiveTab = "general";

    private void SetTabGeneral()
    {
        ActiveTab = "general";
    }

    private void SetTabAux()
    {
        ActiveTab = "aux";
    }

    private void SetTabBank()
    {
        ActiveTab = "bank";
    }

    // filtres
    private string FilterRef = "";
    private string FilterClient = "";
    private DateTime? DateFrom;
    private DateTime? DateTo;

    protected override async Task OnInitializedAsync()
    {
        Invoices = await Data.LoadInvoicesAsync();
        Payments = await Data.LoadPaymentsAsync();

        var (g1, a1) = Generator.GenerateFromInvoices(Invoices);
        var (g2, a2, b) = Generator.GenerateFromPayments(Payments, Invoices);

        AllGeneral = g1.Concat(g2).OrderBy(x => x.Date).ThenBy(x => x.Ref).ToList();
        AllAux = a1.Concat(a2).OrderBy(x => x.Date).ThenBy(x => x.Nom).ToList();
        AllBank = b.OrderBy(x => x.Date).ThenBy(x => x.Ref).ToList();

        ApplyFilters();
        Loading = false;
    }

    private void ApplyFilters()
    {
        bool MatchCommon(DateOnly d, string r, string? client)
        {
            if (!string.IsNullOrWhiteSpace(FilterRef) && !r.Contains(FilterRef, StringComparison.OrdinalIgnoreCase))
                return false;

            if (!string.IsNullOrWhiteSpace(FilterClient) && client is not null &&
                !client.Contains(FilterClient, StringComparison.OrdinalIgnoreCase))
                return false;

            if (DateFrom.HasValue && d < DateOnly.FromDateTime(DateFrom.Value))
                return false;

            if (DateTo.HasValue && d > DateOnly.FromDateTime(DateTo.Value))
                return false;

            return true;
        }

        ViewGeneral = AllGeneral
            .Where(x => MatchCommon(x.Date, x.Ref, null))
            .ToList();

        ViewAux = AllAux
            .Where(x => MatchCommon(x.Date, x.Ref, x.Nom))
            .ToList();

        ViewBank = AllBank
            .Where(x => MatchCommon(x.Date, x.Ref, x.Nom))
            .ToList();
    }

    private void ResetFilters()
    {
        FilterRef = "";
        FilterClient = "";
        DateFrom = null;
        DateTo = null;
        ApplyFilters();
    }

    private static string Fmt(decimal x) => x == 0 ? "" : x.ToString("0.00");

    private async Task DownloadCsv()
    {
        var (fileName, csv) = ActiveTab switch
        {
            "general" => ($"ecritures_generales_{DateTime.Now:yyyyMMdd_HHmm}.csv", CsvBuilder.BuildGeneralCsv(ViewGeneral)),
            "aux" => ($"ecritures_auxiliaires_{DateTime.Now:yyyyMMdd_HHmm}.csv", CsvBuilder.BuildAuxCsv(ViewAux)),
            _ => ($"releve_bancaire_{DateTime.Now:yyyyMMdd_HHmm}.csv", CsvBuilder.BuildBankCsv(ViewBank)),
        };

        var utf8Bom = new byte[] { 0xEF, 0xBB, 0xBF };
        var bytes = utf8Bom.Concat(System.Text.Encoding.UTF8.GetBytes(csv)).ToArray();

        await DownloadBytes(fileName, "text/csv;charset=utf-8", bytes);
    }

    private async Task DownloadBytes(string fileName, string contentType, byte[] bytes)
    {
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFileFromBytes", fileName, contentType, base64);
    }
}
